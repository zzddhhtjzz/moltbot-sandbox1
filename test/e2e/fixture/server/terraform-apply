#!/bin/bash
# Initialize and apply terraform configuration for cloud e2e infrastructure
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# Required environment variables
: "${CLOUDFLARE_API_TOKEN:?CLOUDFLARE_API_TOKEN is required}"
: "${CF_ACCOUNT_ID:?CF_ACCOUNT_ID is required}"
: "${WORKERS_SUBDOMAIN:?WORKERS_SUBDOMAIN is required}"

# Validate we're targeting the correct account
echo "Validating Cloudflare account..." >&2
ACCOUNT_NAME=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID" \
    -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
    -H "Content-Type: application/json" | jq -r '.result.name // empty')

if [ -z "$ACCOUNT_NAME" ]; then
    echo "ERROR: Could not fetch account info for CF_ACCOUNT_ID=$CF_ACCOUNT_ID" >&2
    echo "Check your CLOUDFLARE_API_TOKEN and CF_ACCOUNT_ID" >&2
    exit 1
fi

echo "Deploying to account: $ACCOUNT_NAME (subdomain: $WORKERS_SUBDOMAIN)" >&2

# Optional: unique test run ID (defaults to "local")
TEST_RUN_ID="${E2E_TEST_RUN_ID:-local}"

echo "Initializing terraform..." >&2
terraform init -input=false -upgrade >&2

echo "Applying terraform configuration..." >&2
terraform apply -auto-approve -input=false \
    -var="cloudflare_api_token=$CLOUDFLARE_API_TOKEN" \
    -var="cloudflare_account_id=$CF_ACCOUNT_ID" \
    -var="workers_subdomain=$WORKERS_SUBDOMAIN" \
    -var="test_run_id=$TEST_RUN_ID" \
    >&2

# Output the values for use by other scripts
echo "Terraform outputs:" >&2
terraform output -json
